<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Income Tax Funulator! (2025 Rates)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles */
        body {
            font-family: 'Inter', sans-serif;
            /* Apply the requested background color */
            background-color: #FFFCEB;
        }

        /* Main container styling - Adopted from previous examples */
        .main-container {
            background-color: #ffffff;
            border: 3px solid #2D3748; /* Dark border */
            border-radius: 16px; /* More pronounced rounding */
            box-shadow: 8px 8px 0px #2D3748; /* Stronger offset shadow */
            width: 100%;
            max-width: 42rem; /* max-w-xl equivalent */
            margin-left: auto;
            margin-right: auto;
        }

        /* Playful Input and Select Styling */
        input[type="number"], select {
            width: 100%;
            padding: 0.75rem 1rem; /* py-3 px-4 */
            background-color: #ffffff; /* White background */
            border: 3px solid #4A5568; /* Dark border */
            border-radius: 12px; /* More rounded */
            color: #2D3748; /* Dark text */
            font-weight: 500;
            transition: transform 0.15s ease-out, box-shadow 0.15s ease-out, border-color 0.15s ease-out;
            box-shadow: 4px 4px 0px #4A5568; /* Offset shadow */
            -webkit-appearance: none; /* Remove default appearance */
            -moz-appearance: none;
            appearance: none;
        }
        input[type="number"]::placeholder {
            color: #A0AEC0; /* gray-500 placeholder */
            font-weight: 400;
        }

        /* Custom arrow for selects */
        select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%234A5568' stroke-linecap='round' stroke-linejoin='round' stroke-width='2.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); /* Dark gray arrow */
            background-position: right 0.75rem center;
            background-repeat: no-repeat;
            background-size: 1.25em 1.25em;
            padding-right: 3rem; /* Ensure text doesn't overlap arrow */
        }
        select { color: #2D3748; } /* Ensure select text color */

        /* Focus state for inputs/selects */
        input[type="number"]:focus, select:focus {
            outline: none;
            border-color: #FF7F50; /* Coral border on focus */
            box-shadow: 4px 4px 0px #FF7F50, 0 0 0 3px #FFFCEB; /* Coral shadow + outer ring */
            transform: translateY(-1px) translateX(-1px); /* Slight lift */
        }

        /* Error state for inputs */
        input.border-red-500 {
            border-color: #E53E3E !important; /* Red border */
            box-shadow: 4px 4px 0px #E53E3E !important; /* Red shadow */
        }
        input.border-red-500:focus {
            border-color: #E53E3E !important;
            box-shadow: 4px 4px 0px #E53E3E, 0 0 0 3px #FFFCEB !important; /* Red shadow + outer ring */
        }
        .error-message {
            color: #C53030; /* Darker red */
            font-size: 0.875rem;
            font-weight: 500;
            margin-top: 0.5rem; /* Increased space */
        }

        /* Playful Action Button Style (Calculate) - Adopted */
        #calculateButton {
            background-color: #FF7F50; /* Coral */
            color: white;
            font-weight: 700; /* bold */
            padding-top: 0.85rem; /* Slightly more padding */
            padding-bottom: 0.85rem;
            padding-left: 1rem; /* px-4 */
            padding-right: 1rem;
            border-radius: 0.75rem; /* rounded-xl */
            border: 3px solid #2D3748; /* Darker border */
            box-shadow: 5px 5px 0px #2D3748; /* Bigger shadow */
            transition: all 0.15s ease-out;
            width: 100%;
            text-transform: uppercase; /* Uppercase text */
            letter-spacing: 0.05em; /* Add letter spacing */
        }
        #calculateButton:hover {
            background-color: #FF6347; /* Tomato */
            box-shadow: 6px 6px 0px #2D3748;
            transform: translateY(-2px) translateX(-1px); /* More lift */
        }
         #calculateButton:active {
            background-color: #CD5C5C; /* IndianRed */
            box-shadow: 2px 2px 0px #2D3748;
            transform: translateY(2px) translateX(2px); /* Push down effect */
        }
        #calculateButton:focus {
            outline: none;
            box-shadow: 5px 5px 0px #2D3748, 0 0 0 3px #FFFCEB, 0 0 0 5px #FF7F50; /* Ring effect */
        }
        #calculateButton:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            box-shadow: 4px 4px 0px #9CA3AF; /* Lighter shadow when disabled */
            border-color: #9CA3AF;
            background-color: #FFAC8A; /* Lighter orange */
            transform: none;
        }
         #calculateButton:disabled:hover {
             transform: none;
             box-shadow: 4px 4px 0px #9CA3AF;
         }

        /* Result Section Styling & Animation */
        #result {
            transition: opacity 0.4s ease-in-out, max-height 0.5s ease-out, transform 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55), margin-top 0.4s ease-out, padding 0.4s ease-out, border-width 0.4s ease-out;
            transform: translateY(15px) scale(0.95); /* Start slightly down and smaller */
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            margin-top: 0 !important;
            padding: 0 !important;
            border-width: 0 !important;
            background-color: #FEF3C7; /* amber-100 */
            border-radius: 12px; /* Match inputs */
            border-color: #FDBA74; /* amber-300 */
            box-shadow: 4px 4px 0px #FDBA74;
        }
        #result.visible {
             opacity: 1;
             transform: translateY(0) scale(1); /* Animate to final position/size */
             max-height: 600px; /* Allow more space */
             margin-top: 2rem !important; /* mt-8 */
             padding: 1.5rem !important; /* p-6 */
             border-width: 3px !important; /* Match input border */
        }
        #result h2 {
            color: #C2410C; /* orange-700 */
            font-weight: 700;
            text-align: center;
            border-bottom: 2px dashed #FDBA74; /* Dashed border */
            padding-bottom: 0.75rem; /* pb-3 */
        }
        .result-label {
            font-weight: 600; /* Medium */
            color: #9A3412; /* amber-800 */
            display: inline-block;
            min-width: 160px; /* Adjusted width */
            margin-right: 0.5rem;
        }
        #result p span:last-child { /* Value spans */
            font-weight: 600;
            color: #B45309; /* amber-700 */
            background-color: #FFFBEB; /* amber-50 */
            padding: 3px 8px;
            border-radius: 6px;
            border: 1px solid #FDE68A; /* amber-200 */
            display: inline-block; /* Ensure padding works */
        }
        #result p.total-tax-row span:last-child { /* Total tax value */
             font-weight: 700; /* Bold */
             color: #047857; /* green-700 */
             background-color: #D1FAE5; /* green-100 */
             border-color: #6EE7B7; /* green-300 */
             font-size: 1.25rem; /* text-xl */
        }
        #result .total-tax-row {
             margin-top: 1rem; /* pt-4 */
             padding-top: 1rem;
             border-top: 2px dashed #FDBA74; /* Dashed border */
        }
         #result .total-tax-row .result-label {
             font-weight: 700; /* Bold */
             font-size: 1.125rem; /* text-lg */
             color: #9A3412;
         }

        /* Sub-region Div Transitions */
        .sub-region-div {
            transition: opacity 0.3s ease-in-out, max-height 0.4s ease-out, transform 0.3s ease-out, margin-top 0.3s ease-out, padding-top 0.3s ease-out, padding-bottom 0.3s ease-out;
            transform: translateY(5px); max-height: 0; overflow: hidden; opacity: 0;
            margin-top: 0 !important; padding-top: 0 !important; padding-bottom: 0 !important;
        }
        .sub-region-div.visible-smooth {
             opacity: 1; transform: translateY(0); max-height: 150px; /* Adjust as needed */
             margin-top: 1.5rem !important; /* space-y-6 */
        }

        /* Label style */
        label {
            cursor: pointer;
            color: #4A5568; /* gray-600 */
            font-weight: 600; /* Semibold */
            font-size: 0.875rem; /* text-sm */
            display: block; /* Ensure block */
            margin-bottom: 0.5rem; /* mb-1.5 equivalent */
        }

        /* Notes and Disclaimer */
        .note-text {
            font-size: 0.75rem; /* text-xs */
            color: #718096; /* gray-600 */
            margin-top: 0.5rem; /* mt-1.5 */
            font-style: italic;
        }
        #disclaimer {
            margin-top: 1.5rem; /* mt-6 */
            font-size: 0.75rem; /* text-xs */
            color: #A0AEC0; /* gray-500 */
            text-align: center;
        }

        /* Utility for smooth hide/show */
        .hidden-smooth {
            opacity: 0 !important; max-height: 0 !important; padding-top: 0 !important;
            padding-bottom: 0 !important; margin-top: 0 !important; margin-bottom: 0 !important;
            overflow: hidden !important; border-width: 0 !important; visibility: hidden !important;
            transform: translateY(5px) !important;
        }
        .visible-smooth { /* Used for sub-regions */
            opacity: 1 !important; max-height: 150px !important;
            margin-top: 1.5rem !important;
            transform: translateY(0) !important; visibility: visible !important;
            /* padding and border are handled by the element itself */
        }

    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4 sm:p-6">

    <div class="main-container p-8 md:p-10">
        <h1 class="text-3xl sm:text-4xl font-bold mb-10 text-center text-slate-800 tracking-tight">
            💰 Income Tax Funulator! 💰
        </h1>
        <form id="taxForm" class="space-y-6">

            <div>
                <label for="country">Country</label>
                <select id="country" name="country">
                    <option value="PK" selected>Pakistan (Salaried)</option>
                    <option value="US">United States</option>
                    <option value="GB">United Kingdom</option>
                    <option value="CA">Canada</option>
                    <option value="IN">India (New Regime)</option>
                    <option value="FR">France (National - Simplified)</option>
                    <option value="RU">Russia (National)</option>
                </select>
            </div>

            <div id="usStateDiv" class="hidden-smooth sub-region-div">
                 <label for="usState">State (US)</label>
                 <select id="usState" name="usState">
                     <option value="CA" selected>California</option>
                     <option value="TX">Texas</option>
                     <option value="NY">New York</option>
                     <option value="FL">Florida</option>
                     <option value="IL">Illinois</option>
                     <option value="PA">Pennsylvania</option>
                     <option value="OH">Ohio</option>
                     <option value="GA">Georgia</option>
                     <option value="NC">North Carolina</option>
                     <option value="MI">Michigan</option>
                     <option value="NJ">New Jersey</option>
                     <option value="VA">Virginia</option>
                 </select>
             </div>

            <div id="caProvinceDiv" class="hidden-smooth sub-region-div">
                 <label for="caProvince">Province (Canada)</label>
                  <select id="caProvince" name="caProvince">
                     <option value="ON" selected>Ontario</option>
                     <option value="AB">Alberta</option>
                     <option value="BC">British Columbia</option>
                     <option value="QC">Quebec</option>
                     <option value="MB">Manitoba</option>
                     <option value="SK">Saskatchewan</option>
                     <option value="NS">Nova Scotia</option>
                     <option value="NB">New Brunswick</option>
                 </select>
             </div>

            <div id="ukRegionDiv" class="hidden-smooth sub-region-div">
                 <label for="ukRegion">Region (UK)</label>
                  <select id="ukRegion" name="ukRegion">
                     <option value="EN_NI" selected>England/Northern Ireland</option>
                     <option value="SCT">Scotland</option>
                     <option value="WLS">Wales</option>
                 </select>
             </div>

            <div>
                <label for="income">Total Annual Income (<span id="incomeCurrency">PKR</span>)</label>
                 <input type="number" id="income" name="income" placeholder="e.g., 5000000" required step="any">
                 <p id="incomeError" class="error-message hidden"></p>
            </div>

            <div>
                <label for="deductions">Total Deductions/Allowances (<span id="deductionsCurrency">PKR</span>)</label>
                 <input type="number" id="deductions" name="deductions" placeholder="e.g., 100000" value="0" required step="any">
                 <p id="deductionsError" class="error-message hidden"></p>
                 <p id="ukAllowanceNote" class="note-text hidden">Note: For UK, this is in addition to the standard Personal Allowance (£12,570 for 2025/26).</p>
                 <p id="caAllowanceNote" class="note-text hidden">Note: For Canada, this is before the Basic Personal Amount (BPA) tax credit is applied. Quebec calculation is highly simplified.</p>
                 <p id="frAllowanceNote" class="note-text hidden">Note: For France, calculation assumes a single filer (1 part) and applies a standard 10% deduction for professional expenses (capped) before tax brackets (using 2024 income rates).</p>
                 <p id="usStateNote" class="note-text hidden">Note: US State tax calculated on the same income base as Federal for simplicity; actual state deductions/exemptions may differ significantly.</p>
                 <p id="inNote" class="note-text hidden">Note: India calculation uses New Regime (AY 2025-26), excludes cess/surcharge. Standard Deduction (₹50k) not auto-applied; include in deductions if eligible. Tax rebate u/s 87A not shown.</p>
            </div>

            <button type="submit" id="calculateButton">
                Calculate Tax!
            </button>
        </form>

        <div id="result">
             <h2 class="text-xl mb-5">Your Tax Estimate:</h2>
             <p class="mb-2 flex justify-between items-center"><span class="result-label" id="incomeAfterDeductionsLabel">Taxable Income:</span> <span id="incomeAfterDeductions">PKR 0.00</span></p>
             <p id="ukTaxableIncomeRow" class="hidden-smooth mb-2 flex justify-between items-center"><span class="result-label">UK Taxable (after PA):</span> <span id="taxableIncomeUK">GBP 0.00</span></p>
             <p id="frTaxableIncomeRow" class="hidden-smooth mb-2 flex justify-between items-center"><span class="result-label">FR Taxable (after 10%):</span> <span id="taxableIncomeFR">EUR 0.00</span></p>
             <p id="federalTaxRow" class="hidden-smooth mb-2 flex justify-between items-center"><span class="result-label">Federal/National Tax:</span> <span id="federalTaxAmount">USD 0.00</span></p>
             <p id="regionalTaxRow" class="hidden-smooth mb-2 flex justify-between items-center"><span class="result-label" id="regionalTaxLabel">State/Provincial/Regional Tax:</span> <span id="regionalTaxAmount">USD 0.00</span></p>
             <p class="total-tax-row flex justify-between items-center"><span class="result-label">Total Estimated Tax:</span> <span id="taxAmount">PKR 0.00</span></p>
        </div>

        <p id="disclaimer">
            Disclaimer: Calculations based on simplified rules for illustrative purposes. Consult a tax professional.
        </p>
    </div>

    <script>
        // --- DOM Elements ---
        const taxForm = document.getElementById('taxForm');
        const countrySelect = document.getElementById('country');
        const usStateDiv = document.getElementById('usStateDiv');
        const usStateSelect = document.getElementById('usState');
        const caProvinceDiv = document.getElementById('caProvinceDiv');
        const caProvinceSelect = document.getElementById('caProvince');
        const ukRegionDiv = document.getElementById('ukRegionDiv');
        const ukRegionSelect = document.getElementById('ukRegion');
        const incomeInput = document.getElementById('income');
        const deductionsInput = document.getElementById('deductions');
        const incomeCurrencySpan = document.getElementById('incomeCurrency');
        const deductionsCurrencySpan = document.getElementById('deductionsCurrency');
        const resultDiv = document.getElementById('result');
        const incomeAfterDeductionsSpan = document.getElementById('incomeAfterDeductions');
        const incomeAfterDeductionsLabel = document.getElementById('incomeAfterDeductionsLabel');
        const taxAmountSpan = document.getElementById('taxAmount');
        const calculateButton = document.getElementById('calculateButton');
        const incomeError = document.getElementById('incomeError');
        const deductionsError = document.getElementById('deductionsError');
        const disclaimerP = document.getElementById('disclaimer');
        const ukAllowanceNote = document.getElementById('ukAllowanceNote');
        const caAllowanceNote = document.getElementById('caAllowanceNote');
        const frAllowanceNote = document.getElementById('frAllowanceNote');
        const usStateNote = document.getElementById('usStateNote');
        const inNote = document.getElementById('inNote'); // Added India note
        const ukTaxableIncomeRow = document.getElementById('ukTaxableIncomeRow');
        const taxableIncomeUKSpan = document.getElementById('taxableIncomeUK');
        const frTaxableIncomeRow = document.getElementById('frTaxableIncomeRow');
        const taxableIncomeFRSpan = document.getElementById('taxableIncomeFR');
        const federalTaxRow = document.getElementById('federalTaxRow');
        const federalTaxAmountSpan = document.getElementById('federalTaxAmount');
        const regionalTaxRow = document.getElementById('regionalTaxRow');
        const regionalTaxLabel = document.getElementById('regionalTaxLabel');
        const regionalTaxAmountSpan = document.getElementById('regionalTaxAmount');

        // --- Helper: Marginal Tax Calculation Function ---
        // Calculates tax based on income brackets.
        function calculateMarginalTax(taxableIncome, brackets) {
             let tax = 0; let previousLimit = 0;
             for (const bracket of brackets) {
                 const currentLimit = (bracket.limit === Infinity) ? Infinity : Number(bracket.limit);
                 // Validate bracket limit
                 if (isNaN(currentLimit)) { console.error("Invalid bracket limit:", bracket.limit); continue; }
                 // If income falls into this bracket or beyond
                 if (taxableIncome > previousLimit) {
                     // Calculate income within this specific bracket
                     const incomeInBracket = Math.min(taxableIncome, currentLimit) - previousLimit;
                     // Add tax for this portion of income
                     tax += incomeInBracket * Number(bracket.rate);
                 } else { break; } // Stop if income doesn't reach this bracket
                 // Stop if this is the highest bracket (Infinity)
                 if (currentLimit === Infinity) break;
                 // Set the limit for the next iteration
                 previousLimit = currentLimit;
             }
             return tax > 0 ? tax : 0; // Return calculated tax, ensuring it's not negative
        }

        // --- Tax Data Configuration (Using simplified 2025 rates where available/estimated) ---
        // Stores tax calculation logic and metadata for each country/region.
        const taxData = {
             'PK': { currency: 'PKR', locale: 'en-PK', disclaimer: 'Uses simplified Pakistan tax slabs for salaried individuals (FY 2024-2025) as 2025-26 rates not finalized. Does not include specific allowances/credits.', calculate: function(t){let x=0;if(t<=6e5)x=0;else if(t<=12e5)x=(t-6e5)*0.05;else if(t<=22e5)x=3e4+(t-12e5)*0.15;else if(t<=32e5)x=18e4+(t-22e5)*0.25;else if(t<=41e5)x=43e4+(t-32e5)*0.30;else x=7e5+(t-41e5)*0.35;return{nationalTax:x>0?x:0};} },
             'US': { currency: 'USD', locale: 'en-US', disclaimer: 'Uses simplified US Federal (Single Filer, 2025 est.) and selected State rates (2025 est.). State calculation uses federal income base for simplicity. Does not include standard/itemized deductions, credits, AMT, etc.', calculateNational: function(t){const b=[{limit:11925,rate:0.10},{limit:48475,rate:0.12},{limit:103350,rate:0.22},{limit:197300,rate:0.24},{limit:250525,rate:0.32},{limit:626350,rate:0.35},{limit:Infinity,rate:0.37}];return calculateMarginalTax(t,b);}, states: {'CA':{calculate:function(t){const b=[{limit:10756,rate:0.01},{limit:25499,rate:0.02},{limit:40245,rate:0.04},{limit:55866,rate:0.06},{limit:70606,rate:0.08},{limit:360659,rate:0.093},{limit:432787,rate:0.103},{limit:721314,rate:0.113},{limit:1e6,rate:0.123},{limit:Infinity,rate:0.133}];return calculateMarginalTax(t,b);}},'TX':{calculate:function(t){return 0;}},'NY':{calculate:function(t){const b=[{limit:8500,rate:0.04},{limit:11700,rate:0.045},{limit:13900,rate:0.0525},{limit:80650,rate:0.055},{limit:215400,rate:0.06},{limit:1077550,rate:0.0685},{limit:5e6,rate:0.0965},{limit:25e6,rate:0.103},{limit:Infinity,rate:0.109}];return calculateMarginalTax(t,b);}},'FL':{calculate:function(t){return 0;}},'IL':{calculate:function(t){return t*0.0495;}},'PA':{calculate:function(t){return t*0.0307;}},'OH':{calculate:function(t){if(t<=26050)return 0;if(t<=1e5)return 0.0275*(t-26050);return 2033.63+0.035*(t-1e5);}},'GA':{calculate:function(t){return t*0.0529;}},'NC':{calculate:function(t){return t*0.0425;}},'MI':{calculate:function(t){return t*0.0425;}},'NJ':{calculate:function(t){const b=[{limit:2e4,rate:0.014},{limit:35e3,rate:0.0175},{limit:4e4,rate:0.035},{limit:75e3,rate:0.05525},{limit:5e5,rate:0.0637},{limit:1e6,rate:0.0897},{limit:Infinity,rate:0.1075}];return calculateMarginalTax(t,b);}},'VA':{calculate:function(t){const b=[{limit:3e3,rate:0.02},{limit:5e3,rate:0.03},{limit:17e3,rate:0.05},{limit:Infinity,rate:0.0575}];return calculateMarginalTax(t,b);}}} },
             'GB': { currency: 'GBP', locale: 'en-GB', disclaimer: 'Uses simplified UK Income Tax bands (2025/26 est.) for selected region. Applies standard Personal Allowance (£12,570). Calculates tax on non-savings, non-dividend income only. Does not include National Insurance, PA tapering, etc.', regions: {'EN_NI':{name:'England/NI',calculate:function(i){const p=12570,a=i>125140?0:p,t=Math.max(0,i-a);let x=0;const b=37700,h=125140;if(t<=b)x=t*0.20;else if(t<=h)x=b*0.20+(t-b)*0.40;else x=b*0.20+(h-b)*0.40+(t-h)*0.45;return{regionalTax:x>0?x:0,taxableIncomeDisplay:t};}},'SCT':{name:'Scotland',calculate:function(i){const p=12570,a=i>125140?0:p,t=Math.max(0,i-a);const k=[{limit:2827,rate:0.19},{limit:14921,rate:0.20},{limit:31092,rate:0.21},{limit:62430,rate:0.42},{limit:125140,rate:0.45},{limit:Infinity,rate:0.48}];let x=calculateMarginalTax(t,k);return{regionalTax:x>0?x:0,taxableIncomeDisplay:t};}},'WLS':{name:'Wales',calculate:function(i){const p=12570,a=i>125140?0:p,t=Math.max(0,i-a);let x=0;const b=37700,h=125140;if(t<=b)x=t*0.20;else if(t<=h)x=b*0.20+(t-b)*0.40;else x=b*0.20+(h-b)*0.40+(t-h)*0.45;return{regionalTax:x>0?x:0,taxableIncomeDisplay:t};}}} },
             'CA': { currency: 'CAD', locale: 'en-CA', disclaimer: 'Uses simplified Canadian Federal (2025 est.) and selected Provincial rates (2025 est.). Does not include BPA tax credit or other specifics. Quebec calculation is highly simplified.', calculateNational: function(t){const b=[{limit:57375,rate:0.15},{limit:114750,rate:0.205},{limit:177882,rate:0.26},{limit:253414,rate:0.29},{limit:Infinity,rate:0.33}];return calculateMarginalTax(t,b);}, provinces: {'ON':{name:'Ontario',calculate:function(t){const b=[{limit:52886,rate:0.0505},{limit:105775,rate:0.0915},{limit:15e4,rate:0.1116},{limit:22e4,rate:0.1216},{limit:Infinity,rate:0.1316}];return calculateMarginalTax(t,b);}},'AB':{name:'Alberta',calculate:function(t){const b=[{limit:6e4,rate:0.08},{limit:151234,rate:0.10},{limit:181481,rate:0.12},{limit:241974,rate:0.13},{limit:362961,rate:0.14},{limit:Infinity,rate:0.15}];return calculateMarginalTax(t,b);}},'BC':{name:'British Columbia',calculate:function(t){const b=[{limit:49279,rate:0.0506},{limit:98560,rate:0.077},{limit:113158,rate:0.105},{limit:137407,rate:0.1229},{limit:186306,rate:0.147},{limit:259829,rate:0.168},{limit:Infinity,rate:0.205}];return calculateMarginalTax(t,b);}},'QC':{name:'Quebec',locale:'fr-CA',calculate:function(t){const b=[{limit:53255,rate:0.14},{limit:106495,rate:0.19},{limit:129590,rate:0.24},{limit:Infinity,rate:0.2575}];return calculateMarginalTax(t,b);}},'MB':{name:'Manitoba',calculate:function(t){const b=[{limit:47e3,rate:0.108},{limit:1e5,rate:0.1275},{limit:Infinity,rate:0.174}];return calculateMarginalTax(t,b);}},'SK':{name:'Saskatchewan',calculate:function(t){const b=[{limit:53463,rate:0.105},{limit:152750,rate:0.125},{limit:Infinity,rate:0.145}];return calculateMarginalTax(t,b);}},'NS':{name:'Nova Scotia',calculate:function(t){const b=[{limit:30507,rate:0.0879},{limit:61015,rate:0.1495},{limit:95883,rate:0.1667},{limit:154650,rate:0.175},{limit:Infinity,rate:0.21}];return calculateMarginalTax(t,b);}},'NB':{name:'New Brunswick',calculate:function(t){const b=[{limit:51306,rate:0.094},{limit:102614,rate:0.14},{limit:190060,rate:0.16},{limit:Infinity,rate:0.195}];return calculateMarginalTax(t,b);}}} },
             'IN': { currency: 'INR', locale: 'en-IN', disclaimer: 'Uses simplified India New Tax Regime slabs (AY 2025-26 / FY 2024-25). Excludes cess, surcharge, and Sec 87A rebate. Standard Deduction (₹50k) not auto-applied; include in deductions if eligible.', calculate: function(t){let x=0;if(t<=3e5)x=0;else if(t<=7e5)x=(t-3e5)*0.05;else if(t<=1e6)x=2e4+(t-7e5)*0.10;else if(t<=12e5)x=5e4+(t-1e6)*0.15;else if(t<=15e5)x=8e4+(t-12e5)*0.20;else x=14e4+(t-15e5)*0.30;return{nationalTax:x>0?x:0};} },
             'FR': { currency: 'EUR', locale: 'fr-FR', disclaimer: 'Uses simplified French national income tax scale (2024 income declared in 2025). Assumes single filer (1 part), applies standard 10% deduction (max €14,455). Does not include family quotient, credits, social charges.', calculate: function(i){const d=Math.min(i*0.10,14455),t=Math.max(0,i-d);const b=[{limit:11497,rate:0.00},{limit:29315,rate:0.11},{limit:83823,rate:0.30},{limit:180294,rate:0.41},{limit:Infinity,rate:0.45}];let x=calculateMarginalTax(t,b);return{nationalTax:x>0?x:0,taxableIncomeDisplay:t};} },
              'RU': { currency: 'RUB', locale: 'ru-RU', disclaimer: 'Uses simplified Russian personal income tax rates (2025 est.). Does not include deductions, exemptions, residency nuances.', calculate: function(t){const b=[{limit:24e5,rate:0.13},{limit:5e6,rate:0.15},{limit:2e7,rate:0.18},{limit:5e7,rate:0.20},{limit:Infinity,rate:0.22}];let x=calculateMarginalTax(t,b);return{nationalTax:x>0?x:0};} }
        };

        // --- Helper Functions ---

        // Formats a number as currency based on country code and optional region.
        function formatCurrency(amount, countryCode, provinceOrRegionCode = null) {
            let config = taxData[countryCode];
            let locale = config?.locale;
            let currency = config?.currency;
            // Special case for Quebec locale
            if (countryCode === 'CA' && provinceOrRegionCode === 'QC' && config?.provinces?.QC?.locale) { locale = config.provinces.QC.locale; }
            // Fallback defaults
            locale = locale || 'en-US'; currency = currency || 'USD';
            try {
                // Use Intl.NumberFormat for robust currency formatting
                return amount.toLocaleString(locale, { style: 'currency', currency: currency, minimumFractionDigits: 2, maximumFractionDigits: 2 });
            } catch (e) {
                // Fallback if locale formatting fails
                console.error(`Error formatting currency for locale ${locale} and currency ${currency}:`, e);
                return `${currency} ${amount.toFixed(2)}`;
            }
        }

        // Validates number inputs (income, deductions).
        function validateInput(inputElement, errorElement) {
            const value = inputElement.value.trim();
            // Clear previous errors
            errorElement.textContent = ''; errorElement.classList.add('hidden');
            inputElement.classList.remove('border-red-500');
            // Check if empty
            if (value === '') {
                errorElement.textContent = 'This field is required.'; errorElement.classList.remove('hidden'); inputElement.classList.add('border-red-500'); return false;
            }
            const numberValue = parseFloat(value);
            // Check if valid non-negative number
            if (isNaN(numberValue) || numberValue < 0) {
                errorElement.textContent = 'Please enter a valid non-negative number.'; errorElement.classList.remove('hidden'); inputElement.classList.add('border-red-500'); return false;
            }
            return true; // Input is valid
        }

        // Updates the UI elements based on the selected country.
        function updateUIForCountry(countryCode) {
             const config = taxData[countryCode];
             if (!config) return; // Exit if country config not found

             // Update currency symbols in labels
             incomeCurrencySpan.textContent = config.currency;
             deductionsCurrencySpan.textContent = config.currency;
             // Update disclaimer text
             disclaimerP.textContent = `Disclaimer: ${config.disclaimer} Calculations are for illustrative purposes only. Consult a tax professional for accurate advice.`;

             // Toggle visibility of sub-region selects based on country
             const showUS = countryCode === 'US';
             const showCA = countryCode === 'CA';
             const showGB = countryCode === 'GB';
             usStateDiv.classList.toggle('hidden-smooth', !showUS); usStateDiv.classList.toggle('visible-smooth', showUS);
             caProvinceDiv.classList.toggle('hidden-smooth', !showCA); caProvinceDiv.classList.toggle('visible-smooth', showCA);
             ukRegionDiv.classList.toggle('hidden-smooth', !showGB); ukRegionDiv.classList.toggle('visible-smooth', showGB);

             // Toggle visibility of specific notes
             ukAllowanceNote.classList.toggle('hidden', !showGB);
             caAllowanceNote.classList.toggle('hidden', !showCA);
             frAllowanceNote.classList.toggle('hidden', countryCode !== 'FR');
             usStateNote.classList.toggle('hidden', !showUS);
             inNote.classList.toggle('hidden', countryCode !== 'IN');

             // Reset result section visibility and specific rows
             resultDiv.classList.remove('visible');
             ukTaxableIncomeRow.classList.add('hidden-smooth');
             frTaxableIncomeRow.classList.add('hidden-smooth');
             federalTaxRow.classList.add('hidden-smooth');
             regionalTaxRow.classList.add('hidden-smooth');

             // Adjust label based on country specifics (e.g., UK/FR show pre-taxable income)
             if (countryCode === 'GB' || countryCode === 'FR') { incomeAfterDeductionsLabel.textContent = 'Income After Deductions:'; }
             else { incomeAfterDeductionsLabel.textContent = 'Taxable Income:'; }

             // Reset result values formatted to the new currency
             const selectedProvince = showCA ? caProvinceSelect.value : null;
             incomeAfterDeductionsSpan.textContent = formatCurrency(0, countryCode, selectedProvince);
             taxAmountSpan.textContent = formatCurrency(0, countryCode, selectedProvince);
             federalTaxAmountSpan.textContent = formatCurrency(0, countryCode, selectedProvince);
             regionalTaxAmountSpan.textContent = formatCurrency(0, countryCode, selectedProvince);
             taxableIncomeUKSpan.textContent = formatCurrency(0, 'GB'); // Always format as GBP
             taxableIncomeFRSpan.textContent = formatCurrency(0, 'FR'); // Always format as EUR

             // Clear any validation errors
             incomeInput.classList.remove('border-red-500');
             deductionsInput.classList.remove('border-red-500');
             incomeError.classList.add('hidden'); deductionsError.classList.add('hidden');
             incomeError.textContent = ''; deductionsError.textContent = '';
        }

        // --- Event Listeners ---

        // Update UI when country changes
        countrySelect.addEventListener('change', (event) => {
            updateUIForCountry(event.target.value);
            resultDiv.classList.remove('visible'); // Hide results on country change
        });
        // Hide results if sub-region changes
        usStateSelect.addEventListener('change', () => { resultDiv.classList.remove('visible'); });
        caProvinceSelect.addEventListener('change', () => {
            updateUIForCountry('CA'); // Re-run UI update for potential locale change (QC)
            resultDiv.classList.remove('visible');
        });
        ukRegionSelect.addEventListener('change', () => { resultDiv.classList.remove('visible'); });

        // Handle form submission for tax calculation
        taxForm.addEventListener('submit', function(event) {
            event.preventDefault(); // Prevent default form submission

            // Validate inputs before proceeding
            const isIncomeValid = validateInput(incomeInput, incomeError);
            const isDeductionsValid = validateInput(deductionsInput, deductionsError);
            if (!isIncomeValid || !isDeductionsValid) {
                 resultDiv.classList.remove('visible'); // Hide results if validation fails
                 return;
            }

            // Disable button and show loading state
            calculateButton.disabled = true;
            calculateButton.textContent = 'Calculating...';

            // Use setTimeout to allow UI update before potentially blocking calculation
            setTimeout(() => {
                const income = parseFloat(incomeInput.value);
                const deductions = parseFloat(deductionsInput.value);
                const selectedCountry = countrySelect.value;
                const countryConfig = taxData[selectedCountry];

                let incomeAfterDeductions = Math.max(0, income - deductions);
                let taxableIncome = incomeAfterDeductions; // Base taxable income
                let nationalTax = 0;
                let regionalTax = 0;
                let totalTax = 0;
                let displayTaxableIncomeSpecific = null; // For UK/FR specific taxable income display
                let displayCurrencyCode = selectedCountry; // Currency for formatting
                let displayProvinceCode = null; // For CA/QC locale formatting

                // --- Tax Calculation Logic ---

                if (countryConfig.calculate) { // Countries with single calculation function (PK, FR, RU, IN)
                    const result = countryConfig.calculate(taxableIncome); // Pass income after deductions
                    nationalTax = result.nationalTax;
                    totalTax = nationalTax;
                    // Check if the function returned a specific taxable income to display (e.g., after FR 10% deduction)
                    if (result.taxableIncomeDisplay !== undefined) {
                        displayTaxableIncomeSpecific = result.taxableIncomeDisplay;
                        taxableIncome = displayTaxableIncomeSpecific; // Update taxableIncome used for display label consistency if needed
                    }
                } else if (countryConfig.regions) { // UK - Regional calculation based on income *before* PA
                    const selectedRegion = ukRegionSelect.value;
                    const regionConfig = countryConfig.regions[selectedRegion];
                    if (regionConfig?.calculate) {
                        // UK calculation function expects income *before* PA, handles PA internally
                        const result = regionConfig.calculate(income); // Pass original income
                        regionalTax = result.regionalTax;
                        totalTax = regionalTax;
                        // Get the taxable income after PA from the result
                        if (result.taxableIncomeDisplay !== undefined) {
                            displayTaxableIncomeSpecific = result.taxableIncomeDisplay;
                            taxableIncome = displayTaxableIncomeSpecific; // Update taxableIncome for display
                        }
                        regionalTaxLabel.textContent = `Regional Tax (${regionConfig.name}):`;
                    }
                } else if (countryConfig.calculateNational) { // US, CA - Federal + State/Province
                    nationalTax = countryConfig.calculateNational(taxableIncome);

                    if (selectedCountry === 'US') {
                        const selectedState = usStateSelect.value;
                        if (countryConfig.states?.[selectedState]?.calculate) {
                            regionalTax = countryConfig.states[selectedState].calculate(taxableIncome);
                            regionalTaxLabel.textContent = `State Tax (${selectedState}):`;
                        }
                    } else if (selectedCountry === 'CA') {
                        const selectedProvince = caProvinceSelect.value;
                        displayProvinceCode = selectedProvince; // Needed for QC locale formatting
                        if (countryConfig.provinces?.[selectedProvince]?.calculate) {
                            regionalTax = countryConfig.provinces[selectedProvince].calculate(taxableIncome);
                            regionalTaxLabel.textContent = `Provincial Tax (${countryConfig.provinces[selectedProvince].name}):`;
                        }
                    }
                    totalTax = nationalTax + regionalTax;
                }

                // --- Display results ---

                // Hide all specific rows initially
                ukTaxableIncomeRow.classList.add('hidden-smooth');
                frTaxableIncomeRow.classList.add('hidden-smooth');
                federalTaxRow.classList.add('hidden-smooth');
                regionalTaxRow.classList.add('hidden-smooth');

                // Set the main income display value (Taxable Income or Income After Deductions)
                incomeAfterDeductionsSpan.textContent = formatCurrency(taxableIncome, displayCurrencyCode, displayProvinceCode);
                // If UK/FR, the first line shows income AFTER deductions but BEFORE specific allowances (PA/10%)
                 if (selectedCountry === 'GB' || selectedCountry === 'FR') {
                     incomeAfterDeductionsSpan.textContent = formatCurrency(incomeAfterDeductions, displayCurrencyCode, displayProvinceCode);
                 }


                // Update and show specific taxable income rows ONLY if applicable and value >= 0
                if (displayTaxableIncomeSpecific !== null && displayTaxableIncomeSpecific >= 0) {
                    if (selectedCountry === 'GB') {
                        taxableIncomeUKSpan.textContent = formatCurrency(displayTaxableIncomeSpecific, displayCurrencyCode);
                        ukTaxableIncomeRow.classList.remove('hidden-smooth');
                    } else if (selectedCountry === 'FR') {
                        taxableIncomeFRSpan.textContent = formatCurrency(displayTaxableIncomeSpecific, displayCurrencyCode);
                        frTaxableIncomeRow.classList.remove('hidden-smooth');
                    }
                }

                // Update and show Federal/National tax row if applicable and value >= 0
                if (countryConfig.calculate || countryConfig.calculateNational) {
                     if (nationalTax >= 0) {
                         federalTaxAmountSpan.textContent = formatCurrency(nationalTax, displayCurrencyCode, displayProvinceCode);
                         federalTaxRow.classList.remove('hidden-smooth');
                     }
                }
                 // Update and show Regional/State/Provincial tax row if applicable and value >= 0
                if (countryConfig.regions || (countryConfig.states && selectedCountry === 'US') || (countryConfig.provinces && selectedCountry === 'CA')) {
                     if (regionalTax >= 0) {
                         regionalTaxAmountSpan.textContent = formatCurrency(regionalTax, displayCurrencyCode, displayProvinceCode);
                         regionalTaxRow.classList.remove('hidden-smooth');
                     }
                 }

                // Set total tax amount
                taxAmountSpan.textContent = formatCurrency(totalTax, displayCurrencyCode, displayProvinceCode);

                // Make result section visible with animation
                resultDiv.classList.add('visible');

                // Re-enable button and reset text
                calculateButton.disabled = false;
                calculateButton.textContent = 'Calculate Tax!';

            }, 100); // Short delay for UI responsiveness
        });

        // Real-time validation feedback on input
        incomeInput.addEventListener('input', () => validateInput(incomeInput, incomeError));
        deductionsInput.addEventListener('input', () => validateInput(deductionsInput, deductionsError));

        // Initial Setup on page load
        updateUIForCountry(countrySelect.value); // Set initial UI based on default country

    </script>

</body>
</html>
